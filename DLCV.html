<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DL&CV Embedding Viewer</title>
  <style>
    :root {
      --bg: #0b0b0b;
      --panel: #111;
      --panel2: #141414;
      --fg: rgba(255, 255, 255, .88);
      --muted: rgba(255, 255, 255, .55);
      --line: rgba(255, 255, 255, .10);
      --accent: #7c5cff;
      --ok: #22c55e;
      --warn: #f59e0b;
      --radius: 18px;
      --shadow: 0 20px 60px rgba(0, 0, 0, .55);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: var(--font);
      overflow: hidden;
    }

    button,
    input {
      font-family: inherit;
    }

    .app {
      height: 100vh;
      display: grid;
      grid-template-columns: 340px 1fr 520px;
      gap: 14px;
      padding: 14px;
    }

    .panel {
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      min-height: 0;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid var(--line);
      background: rgba(255, 255, 255, .02);
    }

    .title {
      font-size: 14px;
      font-weight: 650;
      letter-spacing: .2px;
    }

    .meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .pill {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .03);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    /* Left */
    .samples {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
    }

    .samples-toolbar {
      padding: 10px 14px;
      display: flex;
      gap: 8px;
      align-items: center;
      border-bottom: 1px solid var(--line);
    }

    .search {
      flex: 1;
      background: rgba(255, 255, 255, .04);
      border: 1px solid rgba(255, 255, 255, .10);
      color: var(--fg);
      border-radius: 12px;
      padding: 10px 10px;
      outline: none;
      font-size: 13px;
    }

    .smallbtn {
      background: rgba(255, 255, 255, .05);
      border: 1px solid rgba(255, 255, 255, .12);
      color: var(--fg);
      border-radius: 12px;
      padding: 10px 10px;
      cursor: pointer;
      font-size: 13px;
    }

    .smallbtn:hover {
      border-color: rgba(255, 255, 255, .20);
    }

    .grid {
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      overflow: auto;
      min-height: 0;
    }

    .thumb {
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .03);
      cursor: pointer;
      aspect-ratio: 1 / 1;
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform: scale(1.02);
    }

    .thumb::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, transparent 55%, rgba(0, 0, 0, .55));
      opacity: .85;
      pointer-events: none;
    }

    .thumb .cap {
      position: absolute;
      left: 8px;
      right: 8px;
      bottom: 7px;
      z-index: 2;
      font-size: 11px;
      color: rgba(255, 255, 255, .84);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: flex-end;
      line-height: 1.1;
    }

    .thumb .cap span {
      color: rgba(255, 255, 255, .70);
    }

    .thumb.selected {
      outline: 2px solid var(--accent);
      border-color: rgba(124, 92, 255, .65);
    }

    .thumb .check {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .25);
      background: rgba(0, 0, 0, .25);
      display: grid;
      place-items: center;
      z-index: 3;
      opacity: 0;
      transform: translateY(-2px);
      transition: .18s ease;
      font-size: 12px;
    }

    .thumb.selected .check {
      opacity: 1;
      transform: translateY(0);
      border-color: rgba(124, 92, 255, .7);
      background: rgba(124, 92, 255, .18);
    }

    /* Center */
    .center {
      display: flex;
      flex-direction: column;
      min-height: 0;
      height: 100%;
    }

    .center-body {
      flex: 1;
      min-height: 0;
      display: grid;
      place-items: center;
      padding: 18px;
      position: relative;
      overflow: hidden;
    }

    .hero {
      width: min(640px, 100%);
      border-radius: 22px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .03);
      padding: 18px;
      box-shadow: 0 18px 50px rgba(0, 0, 0, .45);
      position: relative;
      overflow: hidden;
    }

    .hero h1 {
      margin: 0 0 6px 0;
      font-size: 22px;
      letter-spacing: .2px;
    }

    .hero p {
      margin: 0 0 16px 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }

    .runrow {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .runbtn {
      flex: 1;
      min-width: 220px;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(124, 92, 255, .55);
      background: linear-gradient(180deg, rgba(124, 92, 255, .22), rgba(124, 92, 255, .10));
      color: var(--fg);
      cursor: pointer;
      font-weight: 700;
      letter-spacing: .2px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      transition: .18s ease;
    }

    .runbtn:hover {
      transform: translateY(-1px);
      border-color: rgba(124, 92, 255, .85);
    }

    .runbtn:disabled {
      opacity: .55;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      flex: 1;
      min-width: 220px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .03);
      color: var(--muted);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .25);
      box-shadow: 0 0 0 4px rgba(255, 255, 255, .06);
      flex: 0 0 auto;
    }

    .dot.ok {
      background: rgba(34, 197, 94, .9);
      box-shadow: 0 0 0 4px rgba(34, 197, 94, .15);
    }

    .dot.busy {
      background: rgba(245, 158, 11, .95);
      box-shadow: 0 0 0 4px rgba(245, 158, 11, .15);
    }

    .orbwrap {
      margin-top: 14px;
      height: 140px;
      border-radius: 18px;
      border: 1px dashed rgba(255, 255, 255, .12);
      background: radial-gradient(120px 120px at 20% 30%, rgba(124, 92, 255, .12), transparent 60%),
        radial-gradient(140px 140px at 80% 70%, rgba(34, 197, 94, .08), transparent 60%),
        rgba(255, 255, 255, .02);
      position: relative;
      overflow: hidden;
    }

    .orb {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .75);
      opacity: .0;
      transform: translate(-50%, -50%);
      transition: opacity .25s ease;
    }

    .orbwrap.running .orb {
      opacity: .85;
      animation: drift 2.2s ease-in-out infinite;
    }

    @keyframes drift {
      0% {
        transform: translate(-50%, -50%) scale(.9);
        opacity: .55;
      }

      50% {
        transform: translate(-50%, -50%) scale(1.25);
        opacity: .95;
      }

      100% {
        transform: translate(-50%, -50%) scale(.9);
        opacity: .55;
      }
    }

    /* Right */
    .results {
      height: 100%;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .results-body {
      padding: 12px;
      overflow: auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .03);
      overflow: hidden;
    }

    .card-head {
      padding: 12px 12px 10px 12px;
      display: flex;
      gap: 8px;
      align-items: flex-start;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, .08);
    }

    .card-head b {
      font-size: 13px;
    }

    .card-head small {
      color: var(--muted);
      font-size: 12px;
      display: block;
      margin-top: 2px;
    }

    .card-body {
      padding: 10px 12px 12px 12px;
    }

    .imgbox {
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(0, 0, 0, .25);
    }

    .imgbox img {
      width: 100%;
      height: auto;
      display: block;
    }

    .reveal {
      display: none;
      animation: pop .22s ease-out both;
    }

    .reveal.show {
      display: block;
    }

    @keyframes pop {
      from {
        opacity: 0;
        transform: translateY(6px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    details.cluster {
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .03);
      overflow: hidden;
    }

    details.cluster>summary {
      cursor: pointer;
      list-style: none;
      padding: 12px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, .08);
    }

    details.cluster>summary::-webkit-details-marker {
      display: none;
    }

    .sum-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sum-left b {
      font-size: 13px;
    }

    .sum-left span {
      font-size: 12px;
      color: var(--muted);
    }

    .chev {
      width: 28px;
      height: 28px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .12);
      display: grid;
      place-items: center;
      color: rgba(255, 255, 255, .70);
      background: rgba(255, 255, 255, .03);
      transition: .15s ease;
    }

    details[open] .chev {
      transform: rotate(180deg);
    }

    .cluster-body {
      padding: 10px 12px 12px 12px;
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
      margin: 0 0 10px 0;
    }

    .footnote {
      padding: 10px 14px;
      border-top: 1px solid var(--line);
      color: rgba(255, 255, 255, .45);
      font-size: 11.5px;
      line-height: 1.45;
    }

    @media (max-width: 1200px) {
      body {
        overflow: auto;
      }

      .app {
        grid-template-columns: 1fr;
        height: auto;
        min-height: 100vh;
      }

      .panel {
        min-height: 460px;
      }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- LEFT -->
    <section class="panel samples">
      <div class="panel-header">
        <div>
          <div class="title">Sample Pool</div>
          <div class="meta">
            <span class="pill" id="selCount">Selected: 0</span>
            <span class="pill">Static dataset</span>
          </div>
        </div>
        <div class="meta"><span class="pill">DL&amp;CV</span></div>
      </div>

      <div class="samples-toolbar">
        <input class="search" id="search" placeholder="Search (e.g., lymphocyte, neutrophil)..." />
        <button class="smallbtn" id="clearBtn" type="button">Clear</button>
      </div>

      <div class="grid" id="sampleGrid"></div>

      <div class="footnote">
        좌측 샘플은 “입력” 역할만 합니다. 버튼 클릭 시 실제 계산 대신, 저장된 결과 이미지를 순차적으로 reveal합니다.
      </div>
    </section>

    <!-- CENTER -->
    <section class="panel center">
      <div class="panel-header">
        <div>
          <div class="title">Embedding Pipeline</div>
          <div class="meta">
            <span class="pill">SimCLR</span>
            <span class="pill">t-SNE</span>
            <span class="pill">KMeans++</span>
          </div>
        </div>
        <div class="meta"><span class="pill" id="modePill">Ready</span></div>
      </div>

      <div class="center-body">
        <div class="hero">
          <h1>Representation Space Viewer</h1>
          <p>
            <b>임베딩 구조 → K 선택 근거(Elbow) → 클러스터링 → 프로토타입(centroid-nearest)</b> 순서로
            representation이 학습한 형태학적 구조를 시각화합니다.
          </p>

          <div class="runrow">
            <button class="runbtn" id="runBtn" type="button">
              <span id="runIcon">▶</span>
              <span id="runText">Generate Embeddings</span>
            </button>

            <div class="status" id="statusBox">
              <span class="dot" id="statusDot"></span>
              <span id="statusText">Idle. Select samples (optional) and press the button.</span>
            </div>
          </div>

          <div class="orbwrap" id="orbwrap" aria-hidden="true">
            <div class="orb" style="left:18%; top:35%; animation-delay:.0s;"></div>
            <div class="orb" style="left:30%; top:60%; animation-delay:.2s;"></div>
            <div class="orb" style="left:45%; top:42%; animation-delay:.35s;"></div>
            <div class="orb" style="left:58%; top:65%; animation-delay:.15s;"></div>
            <div class="orb" style="left:70%; top:40%; animation-delay:.28s;"></div>
            <div class="orb" style="left:82%; top:58%; animation-delay:.05s;"></div>
          </div>

          <p style="margin-top:14px; color:rgba(255,255,255,.55); font-size:12.5px;">
            결과는 우측 패널에 단계적으로 등장합니다.
          </p>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel results">
      <div class="panel-header">
        <div>
          <div class="title">Results</div>
          <div class="meta">
            <span class="pill" id="stepPill">Step: 0/6</span>
            <span class="pill" id="timePill">—</span>
          </div>
        </div>
        <div class="meta">
          <button class="smallbtn" id="resetBtn" type="button">Reset</button>
        </div>
      </div>

      <div class="results-body" id="resultsBody">

        <!-- Step 1: t-SNE (true class) -->
        <div class="card reveal" id="step1">
          <div class="card-head">
            <div>
              <b>Step 1. t-SNE (colored by true class)</b>
              <small>SimCLR 임베딩이 클래스별로 어떤 분포를 갖는지 확인</small>
            </div>
            <span class="pill">2D</span>
          </div>
          <div class="card-body">
            <div class="imgbox">
              <img id="img_tsne_true_2d" alt="t-SNE 2D (true class)" />
            </div>
          </div>
        </div>

        <!-- Step 2: t-SNE 3D (true class) -->
        <div class="card reveal" id="step2">
          <div class="card-head">
            <div>
              <b>Step 2. t-SNE 3D (colored by true class)</b>
              <small>3D 투영으로 분리 구조를 보조적으로 제시</small>
            </div>
            <span class="pill">3D</span>
          </div>
          <div class="card-body">
            <div class="imgbox">
              <img id="img_tsne_true_3d" alt="t-SNE 3D (true class)" />
            </div>
          </div>
        </div>

        <!-- Step 3: Elbow -->
        <div class="card reveal" id="step3">
          <div class="card-head">
            <div>
              <b>Step 3. Elbow method (choose K)</b>
              <small>KMeans 클러스터 수 선택 근거 제시</small>
            </div>
            <span class="pill">Elbow</span>
          </div>
          <div class="card-body">
            <div class="imgbox">
              <img id="img_elbow" alt="Elbow method" />
            </div>
          </div>
        </div>

        <!-- Step 4: t-SNE (colored by clusters) -->
        <div class="card reveal" id="step4">
          <div class="card-head">
            <div>
              <b>Step 4. t-SNE (colored by KMeans clusters)</b>
              <small>KMeans++ (K=5) 클러스터 결과를 임베딩 공간에서 확인</small>
            </div>
            <span class="pill">K=5</span>
          </div>
          <div class="card-body" style="display:flex; flex-direction:column; gap:10px;">
            <div class="imgbox">
              <img id="img_tsne_cluster_2d" alt="t-SNE 2D (clusters)" />
            </div>
            <div class="imgbox">
              <img id="img_tsne_cluster_3d" alt="t-SNE 3D (clusters)" />
            </div>
          </div>
        </div>

        <!-- Step 5: Cluster prototypes (toggle two sets) -->
        <div class="reveal" id="step5">
          <div class="card">
            <div class="card-head">
              <div>
                <b>Step 5. Cluster prototypes (centroid-nearest)</b>
                <small>두 세트(1차 / artifact 제거 후) 결과 토글</small>
              </div>
              <div style="display:flex; gap:8px; align-items:center;">
                <span class="pill" id="clusterSetPill">Set: Raw</span>
                <button class="smallbtn" id="toggleClusterSet" type="button">Toggle</button>
              </div>
            </div>

            <div class="card-body" style="display:flex; flex-direction:column; gap:10px;">
              <p class="hint" style="margin:0;">
                아래 클러스터 카드를 펼치면 각 cluster의 centroid-nearest Top-9 grid가 표시됩니다.
              </p>
              <div id="clusterList" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
          </div>
        </div>

        <!-- Step 6: placeholder -->
        <div class="card reveal" id="step6">
          <div class="card-head">
            <div>
              <b>Step 6. Next results</b>
              <small>Heatmap / Confusion Matrix / Misclassified strip 등을 여기에 추가</small>
            </div>
            <span class="pill">Optional</span>
          </div>
          <div class="card-body" style="color:rgba(255,255,255,.6); font-size:12.5px; line-height:1.55;">
            필요 결과 이미지들을 더 주면 동일한 방식으로 세트 토글까지 묶어서 추가해주겠다.
          </div>
        </div>

        <div class="card" style="background:rgba(255,255,255,.02);">
          <div class="card-body" style="padding:12px;">
            <div style="font-size:12.5px; color:rgba(255,255,255,.62); line-height:1.55;">
              <b style="color:rgba(255,255,255,.86);">Asset base</b><br />
              본 페이지는 <code style="color:rgba(255,255,255,.75);">asset/dlcv/</code> 아래 정적 결과 이미지를 로드합니다.
              파일명에 공백/괄호가 있어도 로드되도록 파일명만 URL 인코딩 처리했습니다.
            </div>
          </div>
        </div>

      </div>

      <div class="footnote">
        “Generate Embeddings”는 데모 트리거입니다. 저장된 결과를 순차 reveal하여 임베딩의 구조/근거/해석 가능성을 한 페이지에서 보여줍니다.
      </div>
    </section>

  </div>

  <script>
    // SAMPLE THUMBNAILS (optional demo)
    const SAMPLE_ITEMS = [
      { src: "asset/dlcv/samples/lymph_01.png", label: "Lymphocyte", id: "S01" },
      { src: "asset/dlcv/samples/lymph_02.png", label: "Lymphocyte", id: "S02" },
      { src: "asset/dlcv/samples/neut_01.png", label: "Neutrophil", id: "S03" },
      { src: "asset/dlcv/samples/neut_02.png", label: "Neutrophil", id: "S04" },
      { src: "asset/dlcv/samples/eos_01.png", label: "Eosinophil", id: "S05" },
      { src: "asset/dlcv/samples/mono_01.png", label: "Monocyte", id: "S06" },
      { src: "asset/dlcv/samples/baso_01.png", label: "Basophil", id: "S07" },
      { src: "asset/dlcv/samples/neut_03.png", label: "Neutrophil", id: "S08" },
      { src: "asset/dlcv/samples/lymph_03.png", label: "Lymphocyte", id: "S09" },
    ];

    // RESULT IMAGES
    const RESULT_IMAGES = {
      tsne_true_2d: "asset/dlcv/SimCLR embeddings - t-SNE 2D.png",
      tsne_true_3d: "asset/dlcv/SimCLR embeddings - t-SNE 3D.png",
      elbow: "asset/dlcv/elbow method on SimCLR t-SNE features.png",
      tsne_kmeans_2d: "asset/dlcv/t-SNE 2D colored by KMeans++ clusters ( K=5).png",
      tsne_kmeans_3d: "asset/dlcv/t-SNE 3D colored by KMeans++ clusters ( K=5).png",
    };

    // Cluster prototypes (two sets)
    const CLUSTER_IMAGE_SETS = {
      raw: {
        name: "Raw",
        clusters: [
          { cid: 0, img: "asset/dlcv/cluster0.png" },
          { cid: 1, img: "asset/dlcv/cluster1.png" },
          { cid: 2, img: "asset/dlcv/cluster2.png" },
          { cid: 3, img: "asset/dlcv/cluster3.png" },
          { cid: 4, img: "asset/dlcv/cluster4.png" },
        ],
      },
      cleaned: {
        name: "Artifact-removed",
        clusters: [
          { cid: 0, img: "asset/dlcv/cluster0-top 9 nearest to centroid.png.png" },
          { cid: 1, img: "asset/dlcv/cluster1-top 9 nearest to centroid.png" },
          { cid: 2, img: "asset/dlcv/cluster2-top 9 nearest to centroid.png" },
          { cid: 3, img: "asset/dlcv/cluster3-top 9 nearest to centroid.png" },
          { cid: 4, img: "asset/dlcv/cluster4-top 9 nearest to centroid.png" },
        ],
      }
    };
    let currentClusterSetKey = "raw";

    // Helpers
    function safeSrc(path) {
      const parts = path.split("/");
      const file = parts.pop();
      return [...parts, encodeURIComponent(file)].join("/");
    }

    const sampleGrid = document.getElementById("sampleGrid");
    const selCount = document.getElementById("selCount");
    const search = document.getElementById("search");
    const clearBtn = document.getElementById("clearBtn");

    const runBtn = document.getElementById("runBtn");
    const runText = document.getElementById("runText");
    const runIcon = document.getElementById("runIcon");

    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const orbwrap = document.getElementById("orbwrap");
    const modePill = document.getElementById("modePill");

    const stepPill = document.getElementById("stepPill");
    const timePill = document.getElementById("timePill");
    const resetBtn = document.getElementById("resetBtn");

    const img_tsne_true_2d = document.getElementById("img_tsne_true_2d");
    const img_tsne_true_3d = document.getElementById("img_tsne_true_3d");
    const img_elbow = document.getElementById("img_elbow");
    const img_tsne_cluster_2d = document.getElementById("img_tsne_cluster_2d");
    const img_tsne_cluster_3d = document.getElementById("img_tsne_cluster_3d");

    const selected = new Set();
    let running = false;
    let startTime = null;
    let timers = [];

    function setStatus(kind, text) {
      statusDot.classList.remove("ok", "busy");
      if (kind === "ok") statusDot.classList.add("ok");
      if (kind === "busy") statusDot.classList.add("busy");
      statusText.textContent = text;
    }

    function setMode(text) { modePill.textContent = text; }
    function updateSelCount() { selCount.textContent = `Selected: ${selected.size}`; }
    function clearTimers() { timers.forEach(t => clearTimeout(t)); timers = []; }

    function renderSamples(items) {
      sampleGrid.innerHTML = "";
      items.forEach((item) => {
        const div = document.createElement("div");
        div.className = "thumb";
        div.dataset.id = item.id;
        div.dataset.label = item.label.toLowerCase();
        div.innerHTML = `
          <div class="check">✓</div>
          <img src="${safeSrc(item.src)}" alt="${item.label} ${item.id}" loading="lazy" />
          <div class="cap">
            <div>${item.id}<br/><span>${item.label}</span></div>
            <div style="opacity:.7;">Pick</div>
          </div>
        `;
        div.addEventListener("click", () => {
          const id = item.id;
          if (selected.has(id)) {
            selected.delete(id);
            div.classList.remove("selected");
          } else {
            selected.add(id);
            div.classList.add("selected");
          }
          updateSelCount();
        });
        sampleGrid.appendChild(div);
      });
      [...sampleGrid.querySelectorAll(".thumb")].forEach(t => {
        if (selected.has(t.dataset.id)) t.classList.add("selected");
      });
    }

    search.addEventListener("input", () => {
      const q = search.value.trim().toLowerCase();
      if (!q) { renderSamples(SAMPLE_ITEMS); return; }
      const filtered = SAMPLE_ITEMS.filter(x =>
        x.label.toLowerCase().includes(q) || x.id.toLowerCase().includes(q)
      );
      renderSamples(filtered);
    });

    clearBtn.addEventListener("click", () => {
      selected.clear();
      updateSelCount();
      search.value = "";
      renderSamples(SAMPLE_ITEMS);
    });

    const RESULT_STEPS = [
      { id: "step1", ms: 650, label: "t-SNE (true class) 2D" },
      { id: "step2", ms: 750, label: "t-SNE (true class) 3D" },
      { id: "step3", ms: 750, label: "Elbow method" },
      { id: "step4", ms: 850, label: "t-SNE (clusters) 2D/3D" },
      { id: "step5", ms: 900, label: "Cluster prototypes" },
      { id: "step6", ms: 650, label: "Next results" },
    ];

    function hideAllSteps() {
      RESULT_STEPS.forEach((s) => {
        const el = document.getElementById(s.id);
        if (el) el.classList.remove("show");
      });
      stepPill.textContent = "Step: 0/6";
      timePill.textContent = "—";
    }

    function showStep(n) {
      const step = RESULT_STEPS[n - 1];
      const el = document.getElementById(step.id);
      if (el) el.classList.add("show");
      stepPill.textContent = `Step: ${n}/6`;
      if (startTime) {
        const sec = ((performance.now() - startTime) / 1000).toFixed(1);
        timePill.textContent = `${sec}s`;
      }
    }

    function renderClusterList() {
      const wrap = document.getElementById("clusterList");
      const pill = document.getElementById("clusterSetPill");
      if (!wrap || !pill) return;

      const set = CLUSTER_IMAGE_SETS[currentClusterSetKey];
      pill.textContent = `Set: ${set.name}`;
      wrap.innerHTML = "";

      set.clusters.forEach(({ cid, img }) => {
        const details = document.createElement("details");
        details.className = "cluster";
        details.innerHTML = `
          <summary>
            <div class="sum-left">
              <b>Cluster ${cid}</b>
              <span>Top-9 nearest to centroid</span>
            </div>
            <div class="chev">⌄</div>
          </summary>
          <div class="cluster-body">
            <div class="imgbox">
              <img src="${safeSrc(img)}" alt="Cluster ${cid} top-9" loading="lazy" />
            </div>
          </div>
        `;
        wrap.appendChild(details);
      });
    }

    const toggleBtn = document.getElementById("toggleClusterSet");
    if (toggleBtn) {
      toggleBtn.addEventListener("click", () => {
        currentClusterSetKey = (currentClusterSetKey === "raw") ? "cleaned" : "raw";
        renderClusterList();
      });
    }

    function bindResultImages() {
      img_tsne_true_2d.src = safeSrc(RESULT_IMAGES.tsne_true_2d);
      img_tsne_true_3d.src = safeSrc(RESULT_IMAGES.tsne_true_3d);
      img_elbow.src = safeSrc(RESULT_IMAGES.elbow);
      img_tsne_cluster_2d.src = safeSrc(RESULT_IMAGES.tsne_kmeans_2d);
      img_tsne_cluster_3d.src = safeSrc(RESULT_IMAGES.tsne_kmeans_3d);
    }

    function startRun() {
      if (running) return;
      running = true;
      runBtn.disabled = true;
      runIcon.textContent = "⏳";
      runText.textContent = "Running…";
      setMode("Running");
      setStatus("busy", selected.size
        ? `Extracting features for ${selected.size} selected samples…`
        : "Extracting features for sample pool…"
      );
      orbwrap.classList.add("running");
      clearTimers();
      hideAllSteps();
      startTime = performance.now();

      let acc = 0;
      RESULT_STEPS.forEach((step, idx) => {
        acc += step.ms;
        timers.push(setTimeout(() => {
          showStep(idx + 1);
          setStatus("busy", `Rendering: ${step.label}…`);
          if (idx === RESULT_STEPS.length - 1) finishRun();
        }, acc));
      });
    }

    function finishRun() {
      timers.push(setTimeout(() => {
        running = false;
        runBtn.disabled = false;
        runIcon.textContent = "▶";
        runText.textContent = "Generate Embeddings";
        setMode("Ready");
        orbwrap.classList.remove("running");
        setStatus("ok", "Done. Results revealed from static assets.");
      }, 350));
    }

    function resetAll() {
      clearTimers();
      hideAllSteps();
      running = false;
      runBtn.disabled = false;
      runIcon.textContent = "▶";
      runText.textContent = "Generate Embeddings";
      setMode("Ready");
      orbwrap.classList.remove("running");
      setStatus("", "Idle. Select samples (optional) and press the button.");
    }

    runBtn.addEventListener("click", startRun);
    resetBtn.addEventListener("click", resetAll);

    renderSamples(SAMPLE_ITEMS);
    updateSelCount();
    setStatus("", "Idle. Select samples (optional) and press the button.");
    bindResultImages();
    renderClusterList();
  </script>
</body>

</html>
